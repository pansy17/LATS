# ğŸ§  Core-RAG: åŸºäº LATS ç­–ç•¥ä¸æ··åˆæ£€ç´¢çš„åŠå¯¼ä½“è¡Œä¸šä¸“å®¶ Agent

> **Core-RAG** æ˜¯ä¸€ä¸ªé«˜ç²¾åº¦çš„è¡Œä¸šç ”ç©¶åŠ©æ‰‹ï¼Œä¸“ä¸ºè§£å†³å¤æ‚ã€é•¿å°¾çš„åŠå¯¼ä½“é¢†åŸŸé—®é¢˜è€Œè®¾è®¡ã€‚
> å®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ª RAG ç³»ç»Ÿï¼Œæ›´æ˜¯ä¸€ä¸ªå®ç°äº† **LATS (Language Agent Tree Search)** ç®—æ³•çš„è‡ªä¸»æ™ºèƒ½ä½“ï¼Œå…·å¤‡**æ€ç»´æ ‘æœç´¢**ã€**è‡ªæˆ‘åæ€**ã€**æœ¯è¯­å½’ä¸€åŒ–**å’Œ**äº‹å®é”šå®š**èƒ½åŠ›ã€‚

---

## ğŸŒŸ æ ¸å¿ƒæŠ€æœ¯äº®ç‚¹ (Key Optimizations)

æœ¬é¡¹ç›®åœ¨æ ‡å‡† RAG çš„åŸºç¡€ä¸Šï¼Œé’ˆå¯¹**æ•°æ®å™ªéŸ³**ã€**å¬å›ä¸å‡†**å’Œ**å¤§æ¨¡å‹å¹»è§‰**ä¸‰å¤§ç—›ç‚¹è¿›è¡Œäº†æ·±åº¦ä¼˜åŒ–ï¼š

### 1. æ•°æ®å±‚ï¼šä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„è¯­ä¹‰åˆ†å— (Context-Aware Semantic Chunking)
* **ç—›ç‚¹1**ï¼šé’ˆå¯¹ä¼ ç»ŸPDFè§£æå®¹æ˜“æ–­ç ã€æ— æ³•è¯†åˆ«å…¬å¼ç­‰é—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†â€œMineruâ€å®ç°äº†æ›´å¥½çš„PDFè§£æã€‚
* **ç—›ç‚¹2**ï¼šä¼ ç»Ÿ RAG å°†é•¿æ–‡æŒ‰å­—ç¬¦æš´åŠ›åˆ‡å‰²ï¼Œå¯¼è‡´â€œå­æ ‡é¢˜â€ä¸â€œæ­£æ–‡â€åˆ†ç¦»ï¼Œä¸¢å¤±å±‚çº§ä¸Šä¸‹æ–‡ã€‚
* **ä¼˜åŒ–æ–¹æ¡ˆ** (`MarkdownParser.py`)ï¼š
* **è¯­ä¹‰å®Œæ•´æ€§**ï¼šé‡‡ç”¨ `SemanticChunker`ï¼ˆåŸºäº OpenAI Embedding å˜åŒ–ç‡ï¼‰è€Œéå›ºå®šå­—ç¬¦æ•°åˆ‡åˆ†ï¼Œç¡®ä¿åˆ‡ç‰‡åœ¨è¯­ä¹‰ä¸Šçš„è¿è´¯æ€§ã€‚
* **çˆ¶çº§ä¸Šä¸‹æ–‡æ³¨å…¥**ï¼šå®ç°äº† `merge_title_content` é€’å½’ç®—æ³•ã€‚åœ¨åˆ‡ç‰‡æ—¶ï¼Œè‡ªåŠ¨å°†æ–‡æ¡£çš„å„çº§æ ‡é¢˜ï¼ˆå¦‚ `# TSMC -> ## 3nmå·¥è‰º -> ### äº§èƒ½`ï¼‰æ³¨å…¥åˆ°æ­£æ–‡åˆ‡ç‰‡å¤´éƒ¨ã€‚
* **æ•ˆæœ**ï¼šå³ä½¿åˆ‡ç‰‡æ˜¯ç‹¬ç«‹çš„ï¼ŒLLM ä¹Ÿèƒ½æ˜ç¡®çŸ¥é“è¯¥æ®µè½å±äº "TSMC" çš„ "3nm" ç« èŠ‚ï¼Œæå¤§æå‡äº†å¬å›å‡†ç¡®ç‡ã€‚



### 2. æ£€ç´¢å±‚ï¼šç¨€ç–ä¸ç¨ å¯†æ··åˆæ£€ç´¢ (Hybrid Search)

* **ç—›ç‚¹**ï¼šDense Retriever (å‘é‡) æ“…é•¿è¯­ä¹‰åŒ¹é…ï¼Œä½†åœ¨åŒ¹é…ä¸“æœ‰åè¯ï¼ˆå¦‚ "GAA", "N3E"ï¼‰æ—¶å¾€å¾€ä¸å¦‚å…³é”®è¯åŒ¹é…ç²¾å‡†ã€‚
* **ä¼˜åŒ–æ–¹æ¡ˆ** (`milvus_db.py`)ï¼š
* **åŒè·¯å¬å›**ï¼šåŒæ—¶ç»´æŠ¤ **Dense Vector** (BGE-Small, 512ç»´) å’Œ **Sparse Vector** (BM25, è¯é¢‘æƒé‡)ã€‚
* **è‡ªå®šä¹‰ BM25**ï¼šåŸºäº `jieba` åˆ†è¯æ‰‹åŠ¨å®ç°äº† BM25 ç®—æ³•ï¼Œè®¡ç®— Token æƒé‡å¹¶å­˜å‚¨ä¸º Milvus çš„ `SPARSE_FLOAT_VECTOR`ã€‚
* **æ•ˆæœ**ï¼šåœ¨å¤„ç†åŠå¯¼ä½“å‹å·ã€å·¥è‰ºä»£å·ç­‰ç²¾ç¡®æŸ¥è¯¢æ—¶ï¼Œå¬å›ç‡æ˜¾è‘—æå‡ã€‚



### 3. è®¤çŸ¥å±‚ï¼šLATS æ€ç»´æ ‘æœç´¢ (Language Agent Tree Search)

* **ç—›ç‚¹**ï¼šReAct æˆ– CoT æ˜¯ä¸€æ¡è·¯èµ°åˆ°é»‘ï¼Œä¸€æ—¦ä¸­é—´æ­¥å‡ºé”™ï¼ˆå¦‚æœç´¢å…³é”®è¯é”™è¯¯ï¼‰ï¼Œæ•´ä¸ªå›ç­”å°±ä¼šå´©å¡Œã€‚
* **ä¼˜åŒ–æ–¹æ¡ˆ** (`LATS_v3.py`)ï¼š
* **MCTS æ¶æ„**ï¼šæ„å»ºæœç´¢æ ‘ï¼ŒåŒ…å« **Selection** (UCTç®—æ³•é€‰æ‹©èŠ‚ç‚¹) -> **Expansion** (ç”Ÿæˆå¤šä¸ªå­æŸ¥è¯¢) -> **Simulation** (æ‰§è¡Œæ£€ç´¢) -> **Backpropagation** (åå‘ä¼ æ’­è¯„åˆ†)ã€‚
* **åŠ¨æ€æ¢ç´¢**ï¼šAgent ä¼šå°è¯•å¤šä¸ªæœç´¢æ–¹å‘ã€‚å¦‚æœæŸä¸ªæ–¹å‘æ£€ç´¢ç»“æœå·®ï¼ˆè¯„åˆ†ä½ï¼‰ï¼Œå®ƒä¼šé€šè¿‡ UCT ç®—æ³•è‡ªåŠ¨è½¬å‘å…¶ä»–æ›´æœ‰æ½œåŠ›çš„è·¯å¾„ï¼Œè€Œéæ­»ç£•ã€‚



### 4. é²æ£’æ€§ï¼šäº‹å®é”šå®šä¸é˜²å¹»è§‰ (Fact Anchoring & Anti-Hallucination)

* **ç—›ç‚¹**ï¼šLLM å–œæ¬¢ç¼–é€ æ•°æ®ï¼Œå°¤å…¶æ˜¯åœ¨äº§èƒ½ã€è‰¯ç‡ç­‰æ•°å­—é—®é¢˜ä¸Šã€‚
* **ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
* **ä¸­é—´ç­”æ¡ˆé”šå®š**ï¼šåœ¨ Simulation é˜¶æ®µï¼Œå¼ºåˆ¶ LLM ç”Ÿæˆå¸¦ `[Ref: ID]` çš„ä¸­é—´ç»“è®ºã€‚
* **å¼•ç”¨æ ¡éªŒæœºåˆ¶** (`evaluation_node`)ï¼šä¸“é—¨çš„ `verify_prompt` æ£€æŸ¥ç”Ÿæˆçš„å›ç­”æ˜¯å¦åŒ…å«äº†å¼•ç”¨ï¼Œä¸”å¼•ç”¨çš„å†…å®¹æ˜¯å¦çœŸå®å­˜åœ¨äºæ£€ç´¢æ–‡ä¸­ã€‚è‹¥å‘ç°æ— å¼•ç”¨æˆ–å¼•ç”¨é€ å‡ï¼Œç»™äºˆ **0åˆ†æƒ©ç½š**ã€‚
* **æ‹’ç­”å¥–åŠ±**ï¼šå¦‚æœ LLM è¯šå®å›ç­”â€œæœªæ‰¾åˆ°ä¿¡æ¯â€ï¼Œç³»ç»Ÿä¼šç»™äºˆå°é¢æ­£å‘å¥–åŠ± (0.1)ï¼Œé¼“åŠ±è¯šå®è€Œéèƒ¡ç¼–ä¹±é€ ã€‚



---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```mermaid
graph TD
    User[ç”¨æˆ·è¾“å…¥] --> Normalizer[å½’ä¸€åŒ–èŠ‚ç‚¹]
    Normalizer -->|æ ‡å‡†åŒ–æŸ¥è¯¢| Root[MCTS æ ¹èŠ‚ç‚¹]
    
    subgraph "LATS Loop (MCTS)"
        Root --> Select[Selection (UCT)]
        Select --> Expand[Expansion (å¤šè§’åº¦å­æŸ¥è¯¢)]
        Expand --> Simulate[Simulation (æ··åˆæ£€ç´¢ + ç½‘é¡µæœç´¢)]
        Simulate --> Evaluate[Evaluation (è´¨é‡æ‰“åˆ†)]
        Evaluate -->|åå‘ä¼ æ’­æ›´æ–° Value| Root
    end
    
    Evaluate -->|è¿­ä»£æ¬¡æ•° < Max| Select
    Evaluate -->|è¿­ä»£æ¬¡æ•° >= Max| Generate[æœ€ç»ˆç ”æŠ¥ç”Ÿæˆ]
    
    subgraph "Data Pipeline"
        MD[Markdown Files] --> Parser[è¯­ä¹‰åˆ†å— + æ ‡é¢˜æ³¨å…¥]
        Parser --> VectorDB[(Milvus: Dense + Sparse)]
        Simulate <--> VectorDB
    end

```

---

## ğŸ“‚ æ¨¡å—è¯¦è§£

### 1. æ™ºèƒ½ä½“æ ¸å¿ƒ (`LATS_v3.py`)

è¿™æ˜¯ç³»ç»Ÿçš„å¤§è„‘ï¼Œå®ç°äº†å®Œæ•´çš„ MCTS æµç¨‹ï¼š

* **Normalize Node**: ä½¿ç”¨æ­£åˆ™ + LLM ä¿®æ­£æœ¯è¯­ï¼ˆä¾‹ï¼š`stm 32` -> `STM32`, `3 nm` -> `3nm Process Node`ï¼‰ã€‚
* **Expansion Node**: æ³¨å…¥äº†åŠå¯¼ä½“è¡Œä¸šçŸ¥è¯†ï¼Œæç¤ºè¯å¼ºåˆ¶è¦æ±‚åŒºåˆ† "WPM" (æ™¶åœ†/æœˆ) å’Œ "Revenue" (è¥æ”¶)ï¼Œé¿å…æ¦‚å¿µæ··æ·†ã€‚
* **Simulation Node**:
* å¹¶è¡Œè°ƒç”¨ `ensemble_retriever` (æœ¬åœ°) å’Œ `GoogleSerper` (ç½‘ç»œ)ã€‚
* ä½¿ç”¨ `temperature=0` ç¡®ä¿ä¸­é—´æ¨ç†çš„äº‹å®æ€§ã€‚


* **Generation Node**: æ”¶é›†æ‰€æœ‰é«˜åˆ†è·¯å¾„ (`value > 0.4`) çš„ä¿¡æ¯ï¼Œå»é‡åç”Ÿæˆç»“æ„åŒ–ç ”æŠ¥ã€‚

### 2. é«˜æ€§èƒ½æ•°æ®ç®¡é“ (`write_milvus.py`)

ä¸ºäº†å¤„ç†å¤§è§„æ¨¡æ–‡æ¡£ï¼Œè®¾è®¡äº† **ç”Ÿäº§è€…-æ¶ˆè´¹è€…** æ¨¡å‹ï¼š

* **Process 1 (Parser)**: CPU å¯†é›†å‹ã€‚è´Ÿè´£ Markdown è§£æã€Header èšåˆã€Semantic Chunkingã€‚
* **Process 2 (Writer)**: IO å¯†é›†å‹ã€‚è´Ÿè´£ Embedding å‘é‡åŒ–ã€BM25 è®¡ç®—ã€Milvus æ‰¹é‡æ’å…¥ã€‚
* **Queue**: ä½¿ç”¨ `multiprocessing.Queue` è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ï¼Œå®ç°æµæ°´çº¿ä½œä¸šã€‚

### 3. çˆ¬è™«å­ç³»ç»Ÿ (`spider_arxiv_project`)

* åŸºäº `Scrapy` æ¡†æ¶ã€‚
* é’ˆå¯¹æ€§æŠ“å– `cat:physics` + `semiconductor` + `2024` çš„æœ€æ–°è®ºæ–‡ã€‚
* è‡ªåŠ¨ä¸‹è½½ PDFï¼Œä¸ºçŸ¥è¯†åº“æä¾›æœ€æ–°çš„å­¦æœ¯å‰æ²¿æ•°æ®ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒå‡†å¤‡

1. å®‰è£…ä¾èµ–ï¼š
```bash
pip install -r requirements.txt

```


2. å¯åŠ¨ Milvus (Docker)ï¼š
```bash
docker run -d --name milvus-standalone -p 19530:19530 -p 9091:9091 milvusdb/milvus:v2.3.0 standalone

```


3. é…ç½® `.env`ï¼š
```ini
OPENAI_API_KEY=sk-...
SERPER_API_KEY=... (ç”¨äº Google Search)
MILVUS_URI=http://localhost:19530

```



### è¿è¡Œæ­¥éª¤

**Step 1: æ„å»ºçŸ¥è¯†åº“**
å°† Markdown èµ„æ–™æ”¾å…¥ `pdf2md/trans_md` ç›®å½•ï¼Œè¿è¡Œæ•°æ®ç®¡é“ï¼š

```bash
python write_milvus.py
# è¾“å‡ºï¼š
# [Info] å¼€å§‹è§£æç›®å½•...
# [Info] æˆåŠŸå†™å…¥ 20 æ¡æ–‡æ¡£ (Hybrid Index)...

```

**Step 2: è¿è¡Œ LATS Agent**
å¯åŠ¨ä¸»ç¨‹åºè¿›è¡Œæ·±åº¦æ¨ç†ï¼š

```bash
python LATS_v3.py

```

*è§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºï¼Œä½ ä¼šçœ‹åˆ° Agent å¦‚ä½•â€œæ€è€ƒâ€ï¼š*

1. `[Normalize]` å°†ä½ çš„å£è¯­åŒ–æé—®è½¬ä¸ºä¸“ä¸šæœ¯è¯­ã€‚
2. `[Expand]` ç”Ÿæˆäº† 3 ä¸ªä¸åŒçš„å­æŸ¥è¯¢æ–¹å‘ã€‚
3. `[Simulate]` å‘ç°æŸä¸ªæ–¹å‘æ£€ç´¢ç»“æœä¸ºç©ºï¼Œè‡ªåŠ¨æ”¾å¼ƒã€‚
4. `[Evaluate]` å¯¹æ£€ç´¢åˆ°çš„äº§èƒ½æ•°æ®æ‰“åˆ†ï¼Œå¹¶è¿›è¡Œåå‘ä¼ æ’­ã€‚
5. `[Generate]` è¾“å‡ºåŒ…å«å¼•ç”¨æ¥æºçš„æœ€ç»ˆæŠ¥å‘Šã€‚

---

## ğŸ“Š æ•ˆæœå¯¹æ¯”

| ç‰¹æ€§ | Easy RAG (Baseline) | Agentic RAG | **Core-RAG (LATS)** |
| --- | --- | --- | --- |
| **æ£€ç´¢æ–¹å¼** | ä»… Dense | Dense + Web | **Dense + Sparse (BM25) + Web** |
| **æŸ¥è¯¢ç†è§£** | åŸæ–‡æ£€ç´¢ | åŸºç¡€é‡å†™ | **æœ¯è¯­å½’ä¸€åŒ– + å¤šè§’åº¦æ‰©å±•** |
| **æ¨ç†è·¯å¾„** | çº¿æ€§ (Chain) | ç®€å•å¾ªç¯ (Loop) | **æ ‘çŠ¶æœç´¢ (Tree) + å›æº¯** |
| **é˜²å¹»è§‰** | æ—  | å¼± | **å¼º (äº‹å®é”šå®š + å¼•ç”¨æ ¡éªŒ)** |
| **é•¿éš¾é—®é¢˜** | æ•ˆæœå·® | ä¸€èˆ¬ | **ä¼˜ç§€ (å¤šæ­¥æ¨ç†)** |

---

## ğŸ›  æŠ€æœ¯æ ˆ

* **Orchestration**: LangChain, LangGraph
* **Vector DB**: Milvus (Hybrid Search)
* **LLM**: GPT-4o-mini
* **Embedding**: BAAI/bge-small-zh-v1.5
* **NLP Tools**: Jieba (BM25), Unstructured (Parsing)


